<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8" /><title>Multi Upload progressif</title></head>
<body>

<input type="file" id="photo-input" accept="image/*" multiple />
<button id="upload-btn">Uploader</button>
<div id="status"></div>
<div id="selected-list"></div>
<div id="gallery"></div>

<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  // ta config Firebase ici
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const photoInput = document.getElementById('photo-input');
const uploadBtn = document.getElementById('upload-btn');
const status = document.getElementById('status');
const selectedList = document.getElementById('selected-list');
const gallery = document.getElementById('gallery');

let filesToUpload = [];

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function updateSelectedList() {
  selectedList.innerHTML = '';
  filesToUpload.forEach((file, i) => {
    const div = document.createElement('div');
    div.textContent = `${file.name} `;
    const btn = document.createElement('button');
    btn.textContent = "Supprimer";
    btn.onclick = () => {
      filesToUpload.splice(i, 1);
      updateSelectedList();
    };
    div.appendChild(btn);
    selectedList.appendChild(div);
  });
}

photoInput.addEventListener('change', () => {
  // Ajouter les nouveaux fichiers à la liste (en évitant doublons par nom)
  for(const f of photoInput.files) {
    if (!filesToUpload.some(file => file.name === f.name && file.size === f.size)) {
      filesToUpload.push(f);
    }
  }
  updateSelectedList();
  // Reset input pour pouvoir re-sélectionner mêmes fichiers si besoin
  photoInput.value = '';
});

uploadBtn.onclick = async () => {
  if (filesToUpload.length === 0) {
    status.textContent = "Aucune photo sélectionnée.";
    return;
  }
  status.textContent = `Upload de ${filesToUpload.length} photos en cours...`;
  try {
    for (const file of filesToUpload) {
      console.log("Upload de : ", file.name);
      const base64 = await readFileAsBase64(file);
      await db.collection('photos').add({
        name: file.name,
        data: base64,
        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    status.textContent = "Upload terminé !";
    filesToUpload = [];
    updateSelectedList();
    loadPhotos();
  } catch (err) {
    console.error(err);
    status.textContent = "Erreur lors de l'upload.";
  }
};

async function loadPhotos() {
  gallery.innerHTML = '';
  const snapshot = await db.collection('photos').orderBy('uploadedAt', 'desc').get();
  snapshot.forEach(doc => {
    const data = doc.data();
    const img = document.createElement('img');
    img.src = data.data;
    img.style.maxWidth = "150px";
    img.style.margin = "5px";
    gallery.appendChild(img);
  });
}

loadPhotos();
</script>

</body>
</html>
